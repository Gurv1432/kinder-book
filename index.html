<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kinder Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Merriweather:wght@300;700&family=Poppins:wght@300;400;500;600;700&family=Tiro+Devanagari+Hindi&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- GLOBAL VARIABLES (THEMING) --- */
        :root {
            /* Default Theme (MeChat Teal) */
            --primary: #128C7E;
            --primary-dark: #075E54;
            --accent: #25D366;
            --bg-color: #f0f2f5;
            --chat-bg: #efeae2;
            --text-main: #111b21;
            --text-sub: #667781;
            --incoming-bubble: #ffffff;
            --outgoing-bubble: #d9fdd3;
            
            /* Book Mode Colors */
            --book-header: #232f3e;
            --book-bg: #fafafa;
            --book-text: #222;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { height: 100%; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; overflow: hidden; background: #000; }

        /* --- VIEW MANAGER --- */
        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: white; flex-direction: column; }
        .active-view { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ========================
           1. DISGUISE LAYER (BOOKS)
           ======================== */
        #view-book-home, #view-book-reader { background: var(--book-bg); font-family: 'Merriweather', serif; }
        .book-header { background: var(--book-header); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .book-search { border: none; padding: 8px 12px; border-radius: 4px; width: 50%; font-family: 'Poppins', sans-serif; }
        .library-grid { padding: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; overflow-y: auto; }
        .book-card { text-align: center; cursor: pointer; }
        .book-cover { height: 110px; background: #eee; border-radius: 4px; margin-bottom: 5px; display: grid; place-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .book-title { font-size: 11px; font-weight: bold; color: var(--book-text); }

        /* Hindi Text Support */
        .hindi-text { font-family: 'Tiro Devanagari Hindi', serif; }

        /* ========================
           2. GATEWAY (CALCULATOR)
           ======================== */
        #view-calculator { background: #1c1c1c; justify-content: flex-end; }
        #calc-display { background: #1c1c1c; color: white; font-size: 60px; text-align: right; padding: 30px; border: none; width: 100%; }
        .calc-pad { display: grid; grid-template-columns: repeat(4, 1fr); }
        .key { padding: 25px; font-size: 24px; color: white; background: #333; border: 0.5px solid #444; text-align: center; cursor: pointer; }
        .key.op { background: #ff9f0a; }

        /* ========================
           3. SECRET LAYER (MECHAT)
           ======================== */
        
        /* LOGIN SCREEN (Based on Screenshot) */
        #view-auth {
            background: linear-gradient(180deg, #124e4d 0%, #176562 100%);
            align-items: center; justify-content: center; padding: 30px;
        }
        .logo-circle {
            width: 120px; height: 120px; background: linear-gradient(135deg, #a4e8e0, #6bbeb5);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .app-brand { font-size: 42px; font-weight: 700; color: #f4c036; margin-bottom: 5px; }
        .app-tagline { color: white; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 40px; }
        
        .auth-input-group { position: relative; width: 100%; margin-bottom: 15px; }
        .auth-icon { position: absolute; left: 15px; top: 14px; color: #666; }
        .me-input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 25px; border: none; font-size: 15px; }
        
        .me-btn { width: 100%; padding: 14px; border-radius: 25px; border: none; background: #1e7f76; color: white; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 10px; }
        .me-btn:active { transform: scale(0.98); }

        /* PROFILE SETUP MODAL */
        #view-profile-setup { background: white; align-items: center; justify-content: center; padding: 30px; }
        .setup-header { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 20px; }
        .avatar-picker { display: flex; gap: 10px; margin-bottom: 20px; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; display: grid; place-items: center; font-size: 20px;}
        .avatar-option.selected { border-color: var(--primary); background: #e0f2f1; }

        /* MAIN APP UI (WhatsApp Style) */
        #view-main-app { background: var(--bg-color); }
        
        /* App Header */
        .wa-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .wa-title { font-size: 20px; font-weight: 600; }
        .wa-tabs { background: var(--primary); display: flex; color: rgba(255,255,255,0.7); }
        .wa-tab { flex: 1; text-align: center; padding: 12px; font-weight: 600; text-transform: uppercase; font-size: 14px; border-bottom: 3px solid transparent; cursor: pointer; }
        .wa-tab.active { color: white; border-bottom-color: white; }
        .badge { background: white; color: var(--primary); border-radius: 10px; padding: 2px 6px; font-size: 10px; vertical-align: top; margin-left: 5px; }

        /* Lists */
        .list-container { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; padding: 12px 15px; background: white; border-bottom: 1px solid #f0f0f0; cursor: pointer; align-items: center; }
        .chat-item:hover { background: #f5f5f5; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; margin-right: 15px; display: grid; place-items: center; font-size: 20px; color: #555; }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 600; font-size: 16px; color: var(--text-main); }
        .chat-preview { font-size: 13px; color: var(--text-sub); margin-top: 3px; }
        .chat-meta { font-size: 11px; color: var(--text-sub); display: flex; flex-direction: column; align-items: flex-end; }
        .btn-small { padding: 5px 12px; border-radius: 15px; font-size: 12px; border: none; cursor: pointer; margin-left: 5px; }
        .btn-accept { background: var(--accent); color: white; }
        .btn-reject { background: #ff4757; color: white; }

        /* Floating Action Button */
        .fab { position: absolute; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--primary-dark); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }

        /* Add Friend Modal */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 85%; }

        /* Chat Room */
        #view-chat-room { background: var(--chat-bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        .room-header { background: var(--primary); color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .msg-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 5px; }
        .bubble { max-width: 75%; padding: 8px 12px; border-radius: 10px; font-size: 14.5px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble.out { align-self: flex-end; background: var(--outgoing-bubble); border-top-right-radius: 0; }
        .bubble.in { align-self: flex-start; background: var(--incoming-bubble); border-top-left-radius: 0; }
        .msg-time { font-size: 10px; color: rgba(0,0,0,0.45); float: right; margin-top: 5px; margin-left: 8px; }
        .input-bar { background: #f0f2f5; padding: 8px; display: flex; align-items: center; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border-radius: 25px; border: none; font-size: 15px; }

        /* THEME SELECTOR */
        .theme-panel { padding: 20px; }
        .theme-option { display: inline-block; width: 40px; height: 40px; border-radius: 50%; margin: 5px; cursor: pointer; border: 2px solid #ddd; }

    </style>
</head>
<body>

    <div id="view-book-home" class="view active-view">
        <div class="book-header">
            <span>My Library</span>
            <input type="number" class="book-search secret-trigger" placeholder="Search title...">
        </div>
        <div class="library-grid" id="library-list">
            </div>
    </div>

    <div id="view-book-reader" class="view">
        <div class="book-header">
            <i class="fas fa-arrow-left" onclick="showView('view-book-home')"></i>
            <span id="reader-title">Reading...</span>
            <input type="number" class="book-search secret-trigger" placeholder="Page..." style="width: 30%">
        </div>
        <div id="reader-content" style="padding: 25px; line-height: 1.8; overflow-y: auto; height: 100%;"></div>
    </div>

    <div id="view-calculator" class="view">
        <input type="text" id="calc-display" readonly value="0">
        <div class="calc-pad" id="calc-keys"></div>
    </div>

    <div id="view-auth" class="view">
        <div class="logo-circle">
            <i class="fas fa-comments" style="font-size: 50px; color: #2c3e50;"></i>
        </div>
        <div class="app-brand">MeChat</div>
        <div class="app-tagline">Talk Freely, Connect Deeply</div>

        <div class="auth-input-group">
            <i class="fas fa-envelope auth-icon"></i>
            <input type="email" id="login-email" class="me-input" placeholder="Email">
        </div>
        <div class="auth-input-group">
            <i class="fas fa-lock auth-icon"></i>
            <input type="password" id="login-pass" class="me-input" placeholder="Password">
        </div>
        
        <button class="me-btn" onclick="handleLogin()">Login</button>
        <p id="auth-msg" style="color: #ffcccc; margin-top: 15px; font-size: 13px; text-align: center;"></p>
        <p style="color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 30px;">Developed by Gaurav Shyam Shukla</p>
    </div>

    <div id="view-profile-setup" class="view">
        <div class="setup-header">Complete Profile</div>
        <div class="avatar-picker">
            <div class="avatar-option selected" onclick="selectAvatar('ü¶Å')">ü¶Å</div>
            <div class="avatar-option" onclick="selectAvatar('ü¶ä')">ü¶ä</div>
            <div class="avatar-option" onclick="selectAvatar('ü¶Ñ')">ü¶Ñ</div>
            <div class="avatar-option" onclick="selectAvatar('üêº')">üêº</div>
            <div class="avatar-option" onclick="selectAvatar('üòé')">üòé</div>
        </div>
        <input type="text" id="setup-username" class="me-input" placeholder="Unique Username" style="border: 1px solid #ddd; margin-bottom: 10px;">
        <input type="text" id="setup-nickname" class="me-input" placeholder="Display Name" style="border: 1px solid #ddd; margin-bottom: 10px;">
        <button class="me-btn" onclick="saveProfile()">Start Chatting</button>
        <p id="setup-msg" style="color: red; font-size: 12px; margin-top: 10px;"></p>
    </div>

    <div id="view-main-app" class="view">
        <div class="wa-header">
            <div class="wa-title">MeChat</div>
            <div>
                <i class="fas fa-search" style="margin-right: 15px;"></i>
                <i class="fas fa-ellipsis-v" onclick="toggleSettings()"></i>
            </div>
        </div>
        <div class="wa-tabs">
            <div class="wa-tab active" onclick="switchTab('chats')">Chats</div>
            <div class="wa-tab" onclick="switchTab('requests')">Requests <span id="req-badge" class="badge"></span></div>
            <div class="wa-tab" onclick="switchTab('settings')">Settings</div>
        </div>

        <div id="tab-chats" class="list-container">
            <div style="padding: 20px; text-align: center; color: #999; margin-top: 50px;">
                <i class="fas fa-comment-slash" style="font-size: 40px; margin-bottom: 10px;"></i><br>
                No chats yet. Add a friend!
            </div>
        </div>

        <div id="tab-requests" class="list-container" style="display:none;">
            </div>

        <div id="tab-settings" class="list-container" style="display:none;">
            <div class="theme-panel">
                <h3>App Theme</h3>
                <div class="theme-option" style="background:#128C7E;" onclick="setTheme('#128C7E')"></div>
                <div class="theme-option" style="background:#0b1929;" onclick="setTheme('#0b1929')"></div>
                <div class="theme-option" style="background:#8e44ad;" onclick="setTheme('#8e44ad')"></div>
                <div class="theme-option" style="background:#c0392b;" onclick="setTheme('#c0392b')"></div>
                <div class="theme-option" style="background:#ff6b81;" onclick="setTheme('#ff6b81')"></div>
                <br><br>
                <button class="me-btn" style="background: #333;" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="fab" onclick="showAddFriendModal()">
            <i class="fas fa-user-plus"></i>
        </div>
    </div>

    <div id="view-chat-room" class="view">
        <div class="room-header">
            <i class="fas fa-arrow-left" onclick="showView('view-main-app')"></i>
            <div id="room-avatar" class="user-avatar" style="width: 35px; height: 35px; margin: 0; font-size: 15px;"></div>
            <div style="flex:1;">
                <div id="room-name" style="font-weight: 600; font-size: 15px;">User</div>
                <div style="font-size: 11px; opacity: 0.8;">Online</div>
            </div>
            <i class="fas fa-video"></i>
            <i class="fas fa-phone" style="margin-left: 15px;"></i>
        </div>
        
        <div id="messages-list" class="msg-container"></div>
        
        <div class="input-bar">
            <i class="far fa-smile" style="color: #666; font-size: 20px;"></i>
            <input type="text" id="msg-input" class="chat-input" placeholder="Message">
            <i class="fas fa-paperclip" style="color: #666; font-size: 20px; margin-right: 10px;"></i>
            <div onclick="sendMessage()" style="width: 45px; height: 45px; background: var(--primary); border-radius: 50%; display: grid; place-items: center; color: white;">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
    </div>

    <div id="modal-add-friend" class="modal-overlay">
        <div class="modal-box">
            <h3>Add New Friend</h3>
            <p>Enter their unique username to send a chat request.</p>
            <input type="text" id="search-username" class="me-input" style="border:1px solid #ddd; background:#f9f9f9;" placeholder="Username (e.g. gaurav123)">
            <div style="display:flex; gap: 10px; margin-top: 15px;">
                <button class="me-btn" onclick="sendFriendRequest()">Send Request</button>
                <button class="me-btn" style="background:#999;" onclick="document.getElementById('modal-add-friend').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
  apiKey: "AIzaSyAwhl7FFVAeDfypJ3AO092efTzLvXgEg5U",
  authDomain: "kinderbook-fd7a6.firebaseapp.com",
  databaseURL: "https://kinderbook-fd7a6-default-rtdb.firebaseio.com",
  projectId: "kinderbook-fd7a6",
  storageBucket: "kinderbook-fd7a6.firebasestorage.app",
  messagingSenderId: "812593237688",
  appId: "1:812593237688:web:249a4b871b9c717b8f2e4d"
};

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- STATE ---
        let currentUser = null;
        let myProfile = null;
        let activeChatId = null;
        let selectedAvatar = 'ü¶Å';

        // --- DISGUISE LOGIC ---
        const library = [
            { t: "The Great Gatsby", l: "en" }, { t: "Godan", l: "hi" },
            { t: "1984", l: "en" }, { t: "Madhushala", l: "hi" },
            { t: "Harry Potter", l: "en" }, { t: "Gaban", l: "hi" }
        ];

        function initLibrary() {
            const grid = document.getElementById('library-list');
            library.forEach(b => {
                const div = document.createElement('div');
                div.className = 'book-card';
                div.innerHTML = `<div class="book-cover"><i class="fas fa-book fa-2x" style="color:#888"></i></div><div class="book-title ${b.l === 'hi' ? 'hindi-text' : ''}">${b.t}</div>`;
                div.onclick = () => openReader(b);
                grid.appendChild(div);
            });
        }

        function openReader(book) {
            document.getElementById('reader-title').innerText = book.t;
            const text = book.l === 'hi' 
                ? "‡§Ø‡§π ‡§è‡§ï ‡§ó‡•Å‡§™‡•ç‡§§ ‡§™‡•Å‡§∏‡•ç‡§§‡§ï ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§∏‡•á ‡§™‡§¢‡§º‡•á‡§Ç‡•§ " 
                : "This is a secret book. Please read carefully. ";
            document.getElementById('reader-content').innerText = text.repeat(50);
            showView('view-book-reader');
        }

        // --- GATEWAY LOGIC ---
        document.querySelectorAll('.secret-trigger').forEach(inp => {
            inp.addEventListener('input', (e) => {
                const val = e.target.value;
                const now = new Date();
                const timeCode = ("0" + now.getHours()).slice(-2) + ("0" + now.getMinutes()).slice(-2);
                if (val === "8127" || val === timeCode) {
                    inp.value = "";
                    showView('view-calculator');
                }
            });
        });

        // Calculator
        const keys = ['7','8','9','/','4','5','6','*','1','2','3','-','C','0','=','+'];
        const pad = document.getElementById('calc-keys');
        let calcVal = "";
        keys.forEach(k => {
            const btn = document.createElement('div');
            btn.className = `key ${['/','*','-','+','='].includes(k) ? 'op' : ''}`;
            btn.innerText = k;
            btn.onclick = () => {
                if(k === 'C') calcVal = "";
                else if(k === '=') {
                    if(calcVal === "812797") { calcVal = ""; checkAuthFlow(); return; }
                    try { calcVal = eval(calcVal).toString(); } catch { calcVal = "Err"; }
                } else calcVal += k;
                document.getElementById('calc-display').value = calcVal || "0";
            };
            pad.appendChild(btn);
        });

        // --- AUTH & PROFILE FLOW ---
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.getElementById(id).classList.add('active-view');
        }

        function checkAuthFlow() {
            if(auth.currentUser) {
                // Check if profile exists
                db.ref('users/' + auth.currentUser.uid).once('value', snap => {
                    if(snap.exists()) {
                        myProfile = snap.val();
                        currentUser = auth.currentUser;
                        loadMainApp();
                    } else {
                        showView('view-profile-setup');
                    }
                });
            } else {
                showView('view-auth');
            }
        }

        function handleLogin() {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(e, p)
                .then(() => checkAuthFlow())
                .catch(err => document.getElementById('auth-msg').innerText = err.message);
        }

        function selectAvatar(av) {
            selectedAvatar = av;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function saveProfile() {
            const user = auth.currentUser;
            const username = document.getElementById('setup-username').value.toLowerCase().trim();
            const nickname = document.getElementById('setup-nickname').value;

            if(!username || !nickname) return alert("All fields required");

            // Check Username uniqueness
            db.ref('usernames/' + username).once('value', snap => {
                if(snap.exists()) {
                    document.getElementById('setup-msg').innerText = "Username already taken!";
                } else {
                    const profile = {
                        uid: user.uid,
                        username: username,
                        nickname: nickname,
                        avatar: selectedAvatar,
                        email: user.email
                    };
                    
                    // Atomic update
                    const updates = {};
                    updates['users/' + user.uid] = profile;
                    updates['usernames/' + username] = user.uid;
                    
                    db.ref().update(updates).then(() => {
                        myProfile = profile;
                        currentUser = user;
                        loadMainApp();
                    });
                }
            });
        }

        // --- MAIN APP LOGIC ---
        function loadMainApp() {
            showView('view-main-app');
            listenToRequests();
            listenToChats();
        }

        function switchTab(tab) {
            document.querySelectorAll('.list-container').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.wa-tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tab).style.display = 'block';
            event.target.classList.add('active');
        }

        // --- FRIEND SYSTEM ---
        function showAddFriendModal() {
            document.getElementById('modal-add-friend').style.display = 'flex';
        }

        function sendFriendRequest() {
            const targetUser = document.getElementById('search-username').value.toLowerCase().trim();
            if(targetUser === myProfile.username) return alert("Cannot add yourself");

            db.ref('usernames/' + targetUser).once('value', snap => {
                if(!snap.exists()) return alert("User not found");
                
                const targetUid = snap.val();
                // Push request
                db.ref(`requests/${targetUid}/${currentUser.uid}`).set({
                    username: myProfile.username,
                    nickname: myProfile.nickname,
                    avatar: myProfile.avatar,
                    timestamp: Date.now()
                }).then(() => {
                    alert("Request Sent!");
                    document.getElementById('modal-add-friend').style.display = 'none';
                });
            });
        }

        function listenToRequests() {
            db.ref(`requests/${currentUser.uid}`).on('value', snap => {
                const container = document.getElementById('tab-requests');
                container.innerHTML = "";
                const count = snap.numChildren();
                document.getElementById('req-badge').innerText = count > 0 ? count : "";

                snap.forEach(child => {
                    const req = child.val();
                    const senderUid = child.key;
                    
                    const div = document.createElement('div');
                    div.className = 'chat-item';
                    div.innerHTML = `
                        <div class="user-avatar">${req.avatar}</div>
                        <div class="chat-info">
                            <div class="chat-name">${req.nickname}</div>
                            <div class="chat-preview">@${req.username} wants to chat</div>
                        </div>
                        <div class="chat-meta">
                            <button class="btn-small btn-accept" onclick="acceptReq('${senderUid}')">Accept</button>
                            <button class="btn-small btn-reject" onclick="rejectReq('${senderUid}')">Ignore</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function acceptReq(senderUid) {
            // Get sender details from request snapshot or fetch user
            db.ref(`users/${senderUid}`).once('value', snap => {
                const sender = snap.val();
                const updates = {};
                // Add to my friends
                updates[`friends/${currentUser.uid}/${senderUid}`] = {
                    nickname: sender.nickname,
                    avatar: sender.avatar,
                    username: sender.username,
                    chatId: getChatId(currentUser.uid, senderUid)
                };
                // Add me to their friends
                updates[`friends/${senderUid}/${currentUser.uid}`] = {
                    nickname: myProfile.nickname,
                    avatar: myProfile.avatar,
                    username: myProfile.username,
                    chatId: getChatId(currentUser.uid, senderUid)
                };
                // Delete request
                updates[`requests/${currentUser.uid}/${senderUid}`] = null;
                
                db.ref().update(updates);
            });
        }

        function rejectReq(uid) {
            db.ref(`requests/${currentUser.uid}/${uid}`).remove();
        }

        // --- CHATTING ---
        function getChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        function listenToChats() {
            db.ref(`friends/${currentUser.uid}`).on('value', snap => {
                const container = document.getElementById('tab-chats');
                container.innerHTML = "";
                
                snap.forEach(child => {
                    const friend = child.val();
                    const friendUid = child.key;
                    
                    const div = document.createElement('div');
                    div.className = 'chat-item';
                    div.innerHTML = `
                        <div class="user-avatar">${friend.avatar}</div>
                        <div class="chat-info">
                            <div class="chat-name">${friend.nickname}</div>
                            <div class="chat-preview">Tap to message</div>
                        </div>
                    `;
                    div.onclick = () => openChat(friendUid, friend);
                    container.appendChild(div);
                });
            });
        }

        function openChat(uid, friend) {
            activeChatId = getChatId(currentUser.uid, uid);
            document.getElementById('room-name').innerText = friend.nickname;
            document.getElementById('room-avatar').innerText = friend.avatar;
            document.getElementById('messages-list').innerHTML = "";
            showView('view-chat-room');
            
            // Listen for messages
            db.ref(`chats/${activeChatId}`).limitToLast(50).on('child_added', snap => {
                const msg = snap.val();
                const isMe = msg.sender === currentUser.uid;
                
                const div = document.createElement('div');
                div.className = `bubble ${isMe ? 'out' : 'in'}`;
                // Ticks simulation
                const ticks = isMe ? `<span style="color:#3498db">‚úì‚úì</span>` : ``;
                
                div.innerHTML = `${msg.text} <div class="msg-time">${ticks}</div>`;
                document.getElementById('messages-list').appendChild(div);
                document.getElementById('messages-list').scrollTop = 99999;
            });
        }

        function sendMessage() {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;
            
            db.ref(`chats/${activeChatId}`).push({
                sender: currentUser.uid,
                text: txt,
                timestamp: Date.now()
            });
            document.getElementById('msg-input').value = "";
        }

        // --- SETTINGS & THEMES ---
        function setTheme(color) {
            document.documentElement.style.setProperty('--primary', color);
            // Slightly darken for header
            // Note: simple implementation, ideal would be calculating HSL
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                showView('view-book-home');
            });
        }

        // --- PANIC MODE ---
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                // Reset State
                document.getElementById('calc-display').value = "0";
                // Show cover
                showView('view-book-home');
            }
        });

        // Initialize
        initLibrary();
        showView('view-book-home');

    </script>
</body>
</html>