<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kinder Book</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Poppins:wght@300;400;500;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- GLOBAL & VARIABLES --- */
        :root {
            /* BOOK MODE COLORS (Kindle Style) */
            --book-bg: #f7f7f7;
            --book-header: #232f3e;
            --book-text: #111;
            
            /* CHAT MODE COLORS (Romantic Theme - Default) */
            --chat-bg: #fff0f5; /* Lavender Blush */
            --chat-header: #ff6b81; /* Soft Pink */
            --chat-accent: #ff4757;
            --msg-out: #ffe4e1;
            --msg-in: #ffffff;
            --text-primary: #2f3542;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Poppins', sans-serif; }

        /* --- VIEW MANAGEMENT --- */
        .view {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: white;
            flex-direction: column;
        }
        .active-view { display: flex; }

        /* ========================
           1. BOOK MODE STYLES
           ======================== */
        #view-book-home, #view-book-reader {
            font-family: 'Merriweather', serif;
            background-color: var(--book-bg);
        }

        .book-header {
            background-color: var(--book-header);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .book-search-bar {
            width: 100%;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background: #fff;
            font-family: 'Poppins', sans-serif;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
        }

        .book-item {
            background: white;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            text-align: center;
            cursor: pointer;
        }
        .book-cover { height: 120px; background: #ddd; margin-bottom: 5px; display:flex; align-items:center; justify-content:center; color:#555;}
        .book-title { font-size: 12px; font-weight: bold; }

        /* Reader View */
        .reader-content {
            padding: 30px;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            overflow-y: auto;
            text-align: justify;
        }

        /* ========================
           2. CALCULATOR STYLES
           ======================== */
        #view-calculator {
            background: #222;
            justify-content: flex-end;
        }
        #calc-display {
            background: #222;
            color: white;
            font-size: 48px;
            text-align: right;
            padding: 20px;
            border: none;
            width: 100%;
        }
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
        }
        .calc-btn {
            background: #333;
            color: white;
            font-size: 24px;
            border: 1px solid #444;
            padding: 20px;
            cursor: pointer;
        }
        .calc-btn.orange { background: #ff9500; }
        .calc-btn:active { background: #555; }

        /* ========================
           3. CHAT APP STYLES
           ======================== */
        /* Login Screen */
        #view-auth {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            align-items: center;
            justify-content: center;
        }
        .auth-box {
            background: rgba(255,255,255,0.9);
            padding: 30px;
            border-radius: 20px;
            width: 85%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .auth-logo { font-family: 'Dancing Script', cursive; font-size: 3rem; color: #ff6b81; margin-bottom: 20px; }
        .app-btn {
            background: var(--chat-header); color: white; border: none; padding: 12px;
            width: 100%; border-radius: 25px; margin-top: 10px; font-weight: 600; cursor: pointer;
        }

        /* Chat UI */
        #view-chat-home, #view-chat-room, #view-admin {
            background: var(--chat-bg);
        }

        .chat-header {
            background: var(--chat-header);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(255,105,135,0.3);
        }
        .header-title { font-family: 'Dancing Script', cursive; font-size: 24px; }
        
        /* Chat List */
        .chat-list { overflow-y: auto; flex: 1; padding-top: 10px;}
        .user-row {
            display: flex; align-items: center; padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer;
            transition: 0.2s;
        }
        .user-row:active { background: rgba(0,0,0,0.05); }
        .user-avatar {
            width: 50px; height: 50px; border-radius: 50%; background: #ddd;
            margin-right: 15px; position: relative;
        }
        .online-dot {
            width: 12px; height: 12px; background: #2ed573; border: 2px solid white;
            border-radius: 50%; position: absolute; bottom: 0; right: 0; display: none;
        }
        .vip-tag {
            background: gold; color: #333; font-size: 10px; padding: 2px 6px;
            border-radius: 10px; font-weight: bold; margin-left: 5px;
        }

        /* Message Room */
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px;
            background-image: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M20 20 L30 30" stroke="%23ffc0cb" stroke-width="1"/></svg>'); /* Subtle pattern */
        }
        .msg {
            max-width: 75%; padding: 10px 14px; border-radius: 15px;
            font-size: 14px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .msg.sent { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
        
        /* Ticks */
        .tick-status { font-size: 10px; margin-left: 5px; color: #999; float: right; margin-top: 5px;}
        .tick-status.read { color: #3498db; } /* Blue Ticks */

        .chat-input-area {
            padding: 10px; background: white; display: flex; align-items: center; gap: 10px;
        }
        .chat-input {
            flex: 1; border: 1px solid #eee; padding: 10px 15px; border-radius: 20px; background: #f9f9f9;
        }

        /* Admin Panel */
        #view-admin { padding: 20px; }
        .admin-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Theme Buttons */
        .theme-selector { display: flex; gap: 10px; padding: 10px; overflow-x: auto; }
        .theme-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }

    </style>
</head>
<body>

    <div id="view-book-home" class="view active-view">
        <div class="book-header">
            <span>Kinder Book</span>
            <input type="number" id="secret-search" class="book-search-bar" placeholder="Search title..." style="width: 60%; margin-left: 10px;">
        </div>
        <div class="book-grid" id="book-grid">
            </div>
    </div>

    <div id="view-book-reader" class="view">
        <div class="book-header">
            <i class="fas fa-arrow-left" onclick="showView('view-book-home')"></i>
            <span id="reader-title">Chapter 1</span>
            <i class="fas fa-font"></i>
        </div>
        <div class="reader-content" id="reader-text">
            </div>
    </div>

    <div id="view-calculator" class="view">
        <input type="text" id="calc-display" readonly value="0">
        <div class="calc-grid" id="calc-keys">
            </div>
    </div>

    <div id="view-auth" class="view">
        <div class="auth-box">
            <div class="auth-logo">Kinder Love</div>
            <p>Welcome to your secret space.</p>
            <input type="email" id="login-id" class="book-search-bar" placeholder="Enter ID (from Admin)" style="margin-bottom: 10px; border: 1px solid #eee;">
            <input type="password" id="login-pass" class="book-search-bar" placeholder="Enter Password" style="margin-bottom: 10px; border: 1px solid #eee;">
            <button class="app-btn" onclick="handleLogin()">ENTER</button>
            <p id="login-error" style="color: red; font-size: 12px; margin-top: 5px;"></p>
        </div>
    </div>

    <div id="view-chat-home" class="view">
        <div class="chat-header">
            <div class="header-title">Kinder Love</div>
            <div>
                <i class="fas fa-palette" onclick="toggleThemePanel()" style="margin-right: 15px;"></i>
                <i class="fas fa-user-cog" onclick="checkAdminAccess()"></i>
            </div>
        </div>
        
        <div id="theme-panel" class="theme-selector" style="display:none; background: rgba(255,255,255,0.8);">
            <div class="theme-btn" style="background: #ff6b81;" onclick="setTheme('romantic')"></div>
            <div class="theme-btn" style="background: #6c5ce7;" onclick="setTheme('purple')"></div>
            <div class="theme-btn" style="background: #00b894;" onclick="setTheme('teal')"></div>
            <div class="theme-btn" style="background: #2d3436;" onclick="setTheme('dark')"></div>
        </div>

        <div id="global-notification" style="background: #ffeaa7; padding: 10px; font-size: 12px; text-align: center; display: none;"></div>

        <div class="chat-list" id="users-list">
            </div>
        
        <div style="padding: 15px; text-align: center;">
             <button class="app-btn" onclick="showInviteModal()">+ Invite User</button>
        </div>
    </div>

    <div id="view-chat-room" class="view">
        <div class="chat-header">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-arrow-left" onclick="showView('view-chat-home')" style="margin-right: 15px;"></i>
                <div class="user-avatar" style="width: 35px; height: 35px; margin-right: 10px;"></div>
                <div>
                    <div id="chat-partner-name" style="font-weight:bold; font-size: 14px;">User</div>
                    <div id="chat-partner-status" style="font-size: 10px; opacity: 0.8;">Online</div>
                </div>
            </div>
            <i class="fas fa-ellipsis-v"></i>
        </div>
        <div class="chat-messages" id="message-container">
            </div>
        <div class="chat-input-area">
            <i class="fas fa-smile" style="color: #888;"></i>
            <i class="fas fa-paperclip" style="color: #888;"></i>
            <input type="text" id="msg-input" class="chat-input" placeholder="Type a message...">
            <i class="fas fa-paper-plane" style="color: var(--chat-accent); font-size: 20px;" onclick="sendMessage()"></i>
        </div>
    </div>

    <div id="view-admin" class="view">
        <div class="chat-header">
            <i class="fas fa-arrow-left" onclick="showView('view-chat-home')"></i>
            <span>Admin Controls</span>
        </div>
        <div style="padding: 20px; overflow-y: auto;">
            <div class="admin-card">
                <h3>Create User</h3>
                <input type="text" id="new-user-id" placeholder="User ID" class="book-search-bar" style="border:1px solid #ccc; margin-bottom:5px;">
                <input type="text" id="new-user-pass" placeholder="Password" class="book-search-bar" style="border:1px solid #ccc; margin-bottom:5px;">
                <button class="app-btn" onclick="adminCreateUser()">Generate</button>
            </div>
            <div class="admin-card">
                <h3>Global Notification</h3>
                <textarea id="admin-notif-text" class="book-search-bar" style="border:1px solid #ccc; height: 60px;"></textarea>
                <button class="app-btn" onclick="adminSendNotification()">Broadcast</button>
            </div>
            <div class="admin-card">
                <h3>User Management</h3>
                <input type="text" id="manage-uid" placeholder="Target User ID" class="book-search-bar" style="border:1px solid #ccc;">
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="app-btn" style="background:gold; color:black" onclick="adminAction('vip')">VIP</button>
                    <button class="app-btn" style="background:orange;" onclick="adminAction('stop')">Stop</button>
                    <button class="app-btn" style="background:red;" onclick="adminAction('delete')">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        /* =========================================
           CONFIGURATION & STATE
           ========================================= */
        const firebaseConfig = {
  apiKey: "AIzaSyAwhl7FFVAeDfypJ3AO092efTzLvXgEg5U",
  authDomain: "kinderbook-fd7a6.firebaseapp.com",
  databaseURL: "https://kinderbook-fd7a6-default-rtdb.firebaseio.com",
  projectId: "kinderbook-fd7a6",
  storageBucket: "kinderbook-fd7a6.firebasestorage.app",
  messagingSenderId: "812593237688",
  appId: "1:812593237688:web:249a4b871b9c717b8f2e4d"
};
        
        // Initialize Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database(); // Realtime DB for presence
        const firestore = firebase.firestore(); // Firestore for chats

        let currentUser = null;
        let currentChatId = null;
        let appState = {
            isPanicMode: false,
            hasPassedBook: false,
            hasPassedCalc: false
        };

        // --- PANIC MODE LOGIC (Minimizing App) ---
        // If user switches tabs or minimizes app, reset everything to Reader View
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                appState.isPanicMode = true;
                // Instant Reset
                appState.hasPassedBook = false;
                appState.hasPassedCalc = false;
                openRandomBook(); // Visual cover
                showView('view-book-reader');
            }
        });

        /* =========================================
           DISGUISE LAYER LOGIC (BOOK & CALC)
           ========================================= */
        
        // 1. Generate Fake Books
        const books = [
            "The Great Gatsby", "1984", "Pride and Prejudice", "Moby Dick", 
            "War and Peace", "Ulysses", "The Odyssey", "Hamlet", "Lolita"
        ];
        const grid = document.getElementById('book-grid');
        books.forEach(title => {
            const div = document.createElement('div');
            div.className = 'book-item';
            div.innerHTML = `<div class="book-cover"><i class="fas fa-book fa-2x"></i></div><div class="book-title">${title}</div>`;
            div.onclick = () => { openRandomBook(); showView('view-book-reader'); };
            grid.appendChild(div);
        });

        // 2. Open Random Book (Panic Destination)
        function openRandomBook() {
            const text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.";
            document.getElementById('reader-text').innerText = text.repeat(20); // Make it look like a full page
            document.getElementById('reader-title').innerText = "Chapter " + Math.floor(Math.random() * 20 + 1);
        }

        // 3. Search Bar Logic (First Gate)
        const searchInput = document.getElementById('secret-search');
        searchInput.addEventListener('input', (e) => {
            const val = e.target.value;
            const now = new Date();
            // Format time HHMM (e.g. 1250)
            const timeCode = ("0" + now.getHours()).slice(-2) + ("0" + now.getMinutes()).slice(-2);
            const masterCode = "8127";

            if (val === timeCode || val === masterCode) {
                searchInput.value = "";
                appState.hasPassedBook = true;
                showView('view-calculator');
            }
        });

        // 4. Calculator Logic (Second Gate)
        const calcKeys = ['7','8','9','/','4','5','6','*','1','2','3','-','C','0','=','+'];
        const calcGrid = document.getElementById('calc-keys');
        const display = document.getElementById('calc-display');
        let calcInput = "";

        calcKeys.forEach(key => {
            const btn = document.createElement('div');
            btn.className = 'calc-btn';
            if(['/','*','-','+','='].includes(key)) btn.className += ' orange';
            btn.innerText = key;
            btn.onclick = () => handleCalcInput(key);
            calcGrid.appendChild(btn);
        });

        function handleCalcInput(key) {
            if (key === 'C') { calcInput = ""; display.value = "0"; return; }
            if (key === '=') { 
                // SECRET CHECK
                if (calcInput === "812797") {
                    appState.hasPassedCalc = true;
                    calcInput = "";
                    checkLoginStatus(); // Proceed to app
                } else {
                    try { display.value = eval(calcInput); } catch { display.value = "Error"; }
                    calcInput = "";
                }
                return;
            }
            calcInput += key;
            display.value = calcInput;
        }

        /* =========================================
           APP LOGIC (CHAT & ADMIN)
           ========================================= */

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.getElementById(id).classList.add('active-view');
        }

        // Logic to determine if we show Login or Home
        function checkLoginStatus() {
            if (currentUser) {
                showView('view-chat-home');
            } else {
                showView('view-auth');
            }
        }

        // Login Handler
        function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            
            // In a real app, you'd map "ID" to "Email" via DB or just use Email
            auth.signInWithEmailAndPassword(id, pass)
                .then(cred => {
                    currentUser = cred.user;
                    updateMyStatus(true);
                    showView('view-chat-home');
                })
                .catch(err => document.getElementById('login-error').innerText = err.message);
        }

        // --- ADMIN FUNCTIONS ---
        function checkAdminAccess() {
            // Hardcoded Admin ID Check (Replace with DB role check)
            if(currentUser.email === "admin@kinderbook.com") {
                showView('view-admin');
            } else {
                alert("Restricted Access");
            }
        }

        // --- CHAT LOGIC ---
        
        // 1. Send Message
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if(!txt) return;

            // Use Firestore for complex querying (auto-delete)
            const msgData = {
                sender: currentUser.uid,
                text: txt,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent' // sent, delivered, read
            };
            
            // Save to DB
            // db.ref(`messages/${currentChatId}`).push(msgData); (Using RTDB for simplicity here)
            // Visual Update happens via listener
            input.value = "";
        }

        // 2. Theming
        function toggleThemePanel() {
            const p = document.getElementById('theme-panel');
            p.style.display = p.style.display === 'none' ? 'flex' : 'none';
        }

        function setTheme(theme) {
            const root = document.documentElement;
            if (theme === 'romantic') {
                root.style.setProperty('--chat-bg', '#fff0f5');
                root.style.setProperty('--chat-header', '#ff6b81');
                root.style.setProperty('--chat-accent', '#ff4757');
            } else if (theme === 'purple') {
                root.style.setProperty('--chat-bg', '#f3e5f5');
                root.style.setProperty('--chat-header', '#6c5ce7');
                root.style.setProperty('--chat-accent', '#a29bfe');
            } else if (theme === 'dark') {
                root.style.setProperty('--chat-bg', '#2d3436');
                root.style.setProperty('--chat-header', '#000000');
                root.style.setProperty('--text-primary', '#dfe6e9');
                root.style.setProperty('--msg-in', '#636e72');
            }
            toggleThemePanel();
        }

        // 3. Auto-Delete Logic (Simulation)
        // In a real app, use Cloud Functions. Here, we run a check on load.
        function cleanOldMessages(chatId) {
            // Pseudo-code logic
            /*
            const now = Date.now();
            messages.forEach(msg => {
                if (msg.status === 'read' && (now - msg.readAt) > 3600000) {
                    deleteMessage(msg.id);
                }
            });
            */
        }

        // 4. Presence System
        function updateMyStatus(isOnline) {
            if(!currentUser) return;
            const ref = db.ref(`status/${currentUser.uid}`);
            if(isOnline) {
                ref.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP });
                ref.onDisconnect().set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP });
            }
        }

        // Initialize Book View on Load
        openRandomBook(); // Fill fake content
        showView('view-book-home');

    </script>
</body>
</html>